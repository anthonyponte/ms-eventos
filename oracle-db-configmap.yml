apiVersion: v1
kind: ConfigMap
metadata:
  name: oracle-db-configmap
data:
  xepdb1.sql: |-
    SELECT SYS_CONTEXT('USERENV', 'CON_NAME') AS CURRENT_CONTAINER FROM DUAL;
    ALTER SESSION SET CONTAINER = XEPDB1;

    CREATE USER dkuser IDENTIFIED BY dkpassword;
    GRANT CONNECT, RESOURCE TO dkuser;
    ALTER USER dkuser QUOTA UNLIMITED ON users;

    CREATE TABLE dkuser.eventos (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        nombre VARCHAR2(255) NOT NULL,
        descripcion VARCHAR2(255) NOT NULL,
        fecha DATE NOT NULL,
        ubicacion VARCHAR2(255) NOT NULL,
        capacidad_max NUMBER NOT NULL
    );

    CREATE TABLE dkuser.participantes (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        dni VARCHAR2(8) NOT NULL,
        nombres_apellidos VARCHAR2(255) NOT NULL,
        fecha_registro TIMESTAMP NOT NULL,
        id_evento NUMBER NOT NULL
    );

    ALTER TABLE dkuser.participantes
    ADD CONSTRAINT fk_participantes_eventos
    FOREIGN KEY (id_evento)
    REFERENCES dkuser.eventos(id);

    CREATE UNIQUE INDEX idx_participantes_01
    ON dkuser.participantes (dni, id_evento);